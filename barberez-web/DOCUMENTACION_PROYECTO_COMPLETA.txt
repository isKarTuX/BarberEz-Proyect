# ğŸ“‹ DOCUMENTACIÃ“N DEL PROYECTO BARBEREZ
## Sistema de GestiÃ³n de BarberÃ­a - Arquitectura y Base de Datos

---

## ğŸ“‘ ÃNDICE

1. [Arquitectura General del Sistema](#arquitectura-general)
2. [Estructura de la Base de Datos](#estructura-base-datos)
3. [ConexiÃ³n a la Base de Datos](#conexion-bd)
4. [Capa de Servicios (LÃ³gica de Negocio)](#capa-servicios)
5. [Capa de Rutas (Controladores)](#capa-rutas)
6. [Frontend - Consumo de APIs](#frontend-apis)
7. [Flujo Completo de una PeticiÃ³n](#flujo-peticion)
8. [Seguridad y AutenticaciÃ³n](#seguridad)
9. [Procedimientos Almacenados](#procedimientos)

---

## 1. ARQUITECTURA GENERAL DEL SISTEMA <a name="arquitectura-general"></a>

### ğŸ—ï¸ Estructura del Proyecto

```
barberez-web/
â”œâ”€â”€ backend/                    # Servidor Node.js + Express
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ database.js        # âš¡ ConfiguraciÃ³n de conexiÃ³n MySQL
â”‚   â”œâ”€â”€ services/              # ğŸ§  LÃ³gica de negocio (llamadas a BD)
â”‚   â”‚   â”œâ”€â”€ authService.js     # AutenticaciÃ³n
â”‚   â”‚   â”œâ”€â”€ citaService.js     # GestiÃ³n de citas
â”‚   â”‚   â”œâ”€â”€ barberoService.js  # GestiÃ³n de barberos
â”‚   â”‚   â”œâ”€â”€ adminService.js    # Panel administrativo
â”‚   â”‚   â”œâ”€â”€ pagoService.js     # Sistema de pagos
â”‚   â”‚   â””â”€â”€ servicioService.js # CatÃ¡logo de servicios
â”‚   â”œâ”€â”€ routes/                # ğŸš¦ Controladores (endpoints API)
â”‚   â”‚   â”œâ”€â”€ authRoutes.js
â”‚   â”‚   â”œâ”€â”€ citaRoutes.js
â”‚   â”‚   â”œâ”€â”€ barberoRoutes.js
â”‚   â”‚   â”œâ”€â”€ adminRoutes.js
â”‚   â”‚   â”œâ”€â”€ pagoRoutes.js
â”‚   â”‚   â””â”€â”€ servicioRoutes.js
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.js            # ğŸ” ValidaciÃ³n de JWT
â”‚   â””â”€â”€ server.js              # ğŸš€ Punto de entrada del servidor
â”‚
â”œâ”€â”€ frontend/                   # Cliente React + Vite
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ api.js         # ğŸ“¡ Axios - Llamadas HTTP al backend
â”‚   â”‚   â”œâ”€â”€ pages/             # Vistas de la aplicaciÃ³n
â”‚   â”‚   â”œâ”€â”€ components/        # Componentes reutilizables
â”‚   â”‚   â””â”€â”€ context/
â”‚   â”‚       â””â”€â”€ AuthContext.jsx # Estado global de autenticaciÃ³n
â”‚
â””â”€â”€ db/
    â”œâ”€â”€ schema.sql             # ğŸ“Š Estructura de tablas
    â””â”€â”€ datos_prueba.sql       # Datos de ejemplo
```

### ğŸ”„ PatrÃ³n de Arquitectura: **MVC con Servicios**

```
Cliente (React) 
    â†“ HTTP Request
Rutas (Controladores) 
    â†“ Llama a
Servicios (LÃ³gica + Consultas SQL) 
    â†“ Ejecuta
Base de Datos MySQL
    â†“ Retorna datos
Servicios â†’ Rutas â†’ Cliente
```

---

## 2. ESTRUCTURA DE LA BASE DE DATOS <a name="estructura-base-datos"></a>

### ğŸ“Š Diagrama Entidad-RelaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (Tabla principal)
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ idUsuario PKâ”‚
â”‚ nombre      â”‚
â”‚ correo      â”‚
â”‚ contrasena  â”‚
â”‚ telefono    â”‚
â”‚ cedula      â”‚
â”‚ rol (ENUM)  â”‚ â† 'admin', 'barbero', 'cliente'
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚  ADMIN   â”‚
       â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    â”‚ idAdmin FKâ”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚   BARBERO    â”‚
       â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    â”‚ idBarbero FK â”‚
       â”‚    â”‚ comision     â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚
       â”‚           â”‚ 1:N
       â”‚           â†“
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚    CITA      â”‚
       â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    â”‚ idCita PK    â”‚
       â”‚    â”‚ fecha        â”‚
       â”‚    â”‚ horaIn       â”‚
       â”‚    â”‚ estado       â”‚
       â”‚    â”‚ idBarbero FK â”‚
       â”‚    â”‚ idCliente FK â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚
       â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚   CLIENTE    â”‚
       â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    â”‚ idCliente FK â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚ 1:N
       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚  SERVICIOCITA    â”‚ (Tabla intermedia M:N)
       â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    â”‚ idCIS PK         â”‚
       â”‚    â”‚ idCita FK        â”‚
       â”‚    â”‚ idSer FK         â”‚
       â”‚    â”‚ total            â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚    SERVICIO      â”‚
       â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚    â”‚ idSer PK         â”‚
       â”‚    â”‚ nombre           â”‚
       â”‚    â”‚ duracion         â”‚
       â”‚    â”‚ precio           â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    PAGO      â”‚
            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
            â”‚ idPago PK    â”‚
            â”‚ idCita FK    â”‚
            â”‚ monto        â”‚
            â”‚ metodoPago   â”‚
            â”‚ estado       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“‹ Tablas Principales

#### 1. **usuario** (Tabla central)
```sql
CREATE TABLE usuario (
    idUsuario INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(100) NOT NULL,
    correo VARCHAR(100) UNIQUE NOT NULL,
    telefono VARCHAR(15),
    contrasena VARCHAR(255) NOT NULL,
    cedula VARCHAR(20) UNIQUE NOT NULL,
    rol ENUM('admin', 'cliente', 'barbero') NOT NULL,
    fechaRegistro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Relaciones:**
- Herencia: Un usuario puede ser admin, cliente o barbero
- 1:1 con admin, barbero o cliente segÃºn su rol

#### 2. **cita** (Tabla de reservas)
```sql
CREATE TABLE cita (
    idCita INT PRIMARY KEY AUTO_INCREMENT,
    fecha DATE NOT NULL,
    horaIn TIME NOT NULL,
    estado ENUM('pendiente', 'confirmada', 'completada', 'cancelada'),
    idCliente INT NOT NULL,
    idBarbero INT NOT NULL,
    fechaCreacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idCliente) REFERENCES cliente(idCliente),
    FOREIGN KEY (idBarbero) REFERENCES barbero(idBarbero),
    UNIQUE KEY unique_barbero_horario (idBarbero, fecha, horaIn)
);
```

**Restricciones:**
- Un barbero NO puede tener dos citas al mismo tiempo
- Las fechas no pueden ser en el pasado (trigger)

#### 3. **servicioCita** (RelaciÃ³n M:N)
```sql
CREATE TABLE servicioCita (
    idCIS INT PRIMARY KEY AUTO_INCREMENT,
    idCita INT NOT NULL,
    idSer INT NOT NULL,
    total DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (idCita) REFERENCES cita(idCita) ON DELETE CASCADE,
    FOREIGN KEY (idSer) REFERENCES servicio(idSer),
    UNIQUE KEY unique_servicio_cita (idCita, idSer)
);
```

**FunciÃ³n:** Conecta mÃºltiples servicios con una cita

---

## 3. CONEXIÃ“N A LA BASE DE DATOS <a name="conexion-bd"></a>

### ğŸ“‚ Archivo: `backend/config/database.js`

```javascript
import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

// âš¡ POOL DE CONEXIONES
// Ventaja: Reutiliza conexiones en lugar de crear nuevas cada vez
const pool = mysql.createPool({
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '',
    database: process.env.DB_NAME || 'barberia_barberez',
    port: process.env.DB_PORT || 3306,
    waitForConnections: true,      // Espera si no hay conexiones disponibles
    connectionLimit: 10,            // MÃ¡ximo 10 conexiones simultÃ¡neas
    queueLimit: 0,                  // Sin lÃ­mite de cola
    enableKeepAlive: true,          // Mantiene conexiones activas
    keepAliveInitialDelay: 0
});

// âœ… VERIFICAR CONEXIÃ“N AL INICIAR
pool.getConnection()
    .then(connection => {
        console.log('âœ… ConexiÃ³n a MySQL establecida correctamente');
        connection.release();  // Devuelve la conexiÃ³n al pool
    })
    .catch(err => {
        console.error('âŒ Error conectando a MySQL:', err.message);
        process.exit(1);  // Detiene el servidor si falla la conexiÃ³n
    });

export default pool;
```

### ğŸ”‘ Variables de Entorno (`.env`)

```env
# ConfiguraciÃ³n de Base de Datos
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=tu_password
DB_NAME=barberia_barberez
DB_PORT=3306

# ConfiguraciÃ³n JWT
JWT_SECRET=secret_key_barberez_2024
JWT_REFRESH_SECRET=refresh_secret_barberez_2024

# Entorno
NODE_ENV=development
PORT=5000
```

### ğŸ’¡ Â¿Por quÃ© usar un Pool de Conexiones?

```
âŒ SIN POOL (Ineficiente):
Cliente â†’ Nueva ConexiÃ³n â†’ Query â†’ Cierra ConexiÃ³n
Cliente â†’ Nueva ConexiÃ³n â†’ Query â†’ Cierra ConexiÃ³n
Cliente â†’ Nueva ConexiÃ³n â†’ Query â†’ Cierra ConexiÃ³n
(Crear/cerrar conexiones es costoso)

âœ… CON POOL (Eficiente):
Cliente â†’ Toma ConexiÃ³n del Pool â†’ Query â†’ Devuelve al Pool
Cliente â†’ Reutiliza ConexiÃ³n â†’ Query â†’ Devuelve al Pool
Cliente â†’ Reutiliza ConexiÃ³n â†’ Query â†’ Devuelve al Pool
(Las conexiones se reutilizan)
```

---

## 4. CAPA DE SERVICIOS (LÃ“GICA DE NEGOCIO) <a name="capa-servicios"></a>

### ğŸ§  Â¿QuÃ© son los Servicios?

Los **servicios** son clases que contienen:
- âœ… LÃ³gica de negocio
- âœ… Consultas SQL a la base de datos
- âœ… Validaciones
- âœ… Manejo de errores

**Ventaja:** Separa la lÃ³gica de negocio de las rutas (controladores).

---

### ğŸ“„ Ejemplo 1: `authService.js` - AutenticaciÃ³n

```javascript
import pool from '../config/database.js';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'secret_key_barberez_2024';
const JWT_EXPIRES_IN = '8h';

class AuthService {
    // ğŸ” LOGIN - Autenticar usuario
    static async login(correo, contrasena) {
        try {
            // 1ï¸âƒ£ BUSCAR USUARIO POR CORREO
            const [users] = await pool.execute(
                'SELECT * FROM usuario WHERE correo = ?',
                [correo]
            );

            if (users.length === 0) {
                throw new Error('Usuario no encontrado');
            }

            const user = users[0];

            // 2ï¸âƒ£ VERIFICAR CONTRASEÃ‘A
            // Detecta si es bcrypt hash o texto plano
            const isBcryptHash = /^\$2[aby]\$/.test(user.contrasena);
            let isPasswordValid = false;
            
            if (isBcryptHash) {
                // ContraseÃ±a hasheada con bcrypt
                isPasswordValid = await bcrypt.compare(contrasena, user.contrasena);
            } else {
                // ContraseÃ±a en texto plano (compatibilidad)
                isPasswordValid = user.contrasena === contrasena;
                
                // Migrar a bcrypt automÃ¡ticamente
                if (isPasswordValid) {
                    const hashedPassword = await bcrypt.hash(contrasena, 10);
                    await pool.execute(
                        'UPDATE usuario SET contrasena = ? WHERE idUsuario = ?',
                        [hashedPassword, user.idUsuario]
                    );
                    console.warn(`âœ… ContraseÃ±a migrada a bcrypt para: ${user.correo}`);
                }
            }

            if (!isPasswordValid) {
                throw new Error('ContraseÃ±a incorrecta');
            }

            // 3ï¸âƒ£ GENERAR TOKEN JWT
            delete user.contrasena;  // NO enviar contraseÃ±a al cliente
            
            const token = jwt.sign(
                { 
                    idUsuario: user.idUsuario,
                    correo: user.correo,
                    rol: user.rol,
                    nombre: user.nombre
                },
                JWT_SECRET,
                { expiresIn: JWT_EXPIRES_IN }
            );

            // 4ï¸âƒ£ RETORNAR USUARIO + TOKEN
            return { 
                ...user, 
                token,
                expiresIn: JWT_EXPIRES_IN
            };
        } catch (error) {
            throw error;
        }
    }

    // ğŸ“ REGISTRAR NUEVO USUARIO
    static async register(userData) {
        const { nombre, correo, telefono, contrasena, cedula, rol, comision = 0 } = userData;

        try {
            // 1ï¸âƒ£ VERIFICAR SI EL CORREO YA EXISTE
            const [existing] = await pool.execute(
                'SELECT idUsuario FROM usuario WHERE correo = ? OR cedula = ?',
                [correo, cedula]
            );

            if (existing.length > 0) {
                throw new Error('El correo o cÃ©dula ya estÃ¡n registrados');
            }

            // 2ï¸âƒ£ HASHEAR CONTRASEÃ‘A
            const hashedPassword = await bcrypt.hash(contrasena, 10);

            // 3ï¸âƒ£ INSERTAR USUARIO
            const [result] = await pool.execute(
                'INSERT INTO usuario (nombre, correo, telefono, contrasena, cedula, rol, comision) VALUES (?, ?, ?, ?, ?, ?, ?)',
                [nombre, correo, telefono, hashedPassword, cedula, rol, comision]
            );

            return { id: result.insertId, nombre, correo, rol };
        } catch (error) {
            throw error;
        }
    }
}

export default AuthService;
```

**ğŸ“Š Flujo de Login:**

```
Cliente envÃ­a: { correo: "admin@barberez.com", contrasena: "admin123" }
       â†“
authRoutes.js recibe la peticiÃ³n POST /api/auth/login
       â†“
Llama a: AuthService.login(correo, contrasena)
       â†“
1. Ejecuta: SELECT * FROM usuario WHERE correo = ?
2. Verifica contraseÃ±a con bcrypt.compare()
3. Genera JWT con jwt.sign()
       â†“
Retorna: { idUsuario, nombre, correo, rol, token }
       â†“
authRoutes.js envÃ­a respuesta al cliente
       â†“
Cliente guarda el token en localStorage
```

---

### ğŸ“„ Ejemplo 2: `citaService.js` - GestiÃ³n de Citas

```javascript
import pool from '../config/database.js';

class CitaService {
    // ğŸ“… OBTENER CITAS DE UN CLIENTE
    static async getCitasCliente(idCliente, estado = null) {
        try {
            let query = `
                SELECT 
                    c.idCita,
                    c.fecha,
                    c.horaIn,
                    c.estado,
                    u.nombre as nombreBarbero,
                    u.telefono as telefonoBarbero,
                    GROUP_CONCAT(s.nombre SEPARATOR ', ') as servicios,
                    SUM(sc.total) as totalCita
                FROM cita c
                INNER JOIN barbero b ON c.idBarbero = b.idBarbero
                INNER JOIN usuario u ON b.idBarbero = u.idUsuario
                LEFT JOIN servicioCita sc ON c.idCita = sc.idCita
                LEFT JOIN servicio s ON sc.idSer = s.idSer
                WHERE c.idCliente = ?
            `;

            const params = [idCliente];

            // FILTRO OPCIONAL POR ESTADO
            if (estado) {
                query += ' AND c.estado = ?';
                params.push(estado);
            }

            query += ' GROUP BY c.idCita ORDER BY c.fecha DESC, c.horaIn DESC';

            const [citas] = await pool.execute(query, params);
            return citas;
        } catch (error) {
            throw error;
        }
    }

    // â• CREAR NUEVA CITA
    static async crearCita(citaData) {
        const { fecha, horaIn, idCliente, idBarbero, servicios, metodoPago } = citaData;

        // USAR TRANSACCIÃ“N (todas las operaciones o ninguna)
        const connection = await pool.getConnection();
        
        try {
            await connection.beginTransaction();

            // 1ï¸âƒ£ VERIFICAR DISPONIBILIDAD DEL BARBERO
            const [conflicto] = await connection.execute(
                `SELECT idCita FROM cita 
                 WHERE idBarbero = ? AND fecha = ? AND horaIn = ? 
                 AND estado IN ('pendiente', 'confirmada')`,
                [idBarbero, fecha, horaIn]
            );

            if (conflicto.length > 0) {
                throw new Error('El barbero ya tiene una cita a esa hora');
            }

            // 2ï¸âƒ£ CREAR LA CITA
            const [resultCita] = await connection.execute(
                'INSERT INTO cita (fecha, horaIn, idCliente, idBarbero) VALUES (?, ?, ?, ?)',
                [fecha, horaIn, idCliente, idBarbero]
            );

            const idCita = resultCita.insertId;

            // 3ï¸âƒ£ AGREGAR SERVICIOS
            let montoTotal = 0;
            for (const idSer of servicios) {
                // Obtener precio del servicio
                const [servicio] = await connection.execute(
                    'SELECT precio FROM servicio WHERE idSer = ? AND activo = TRUE',
                    [idSer]
                );

                if (servicio.length === 0) {
                    throw new Error(`Servicio ${idSer} no encontrado o inactivo`);
                }

                const precio = servicio[0].precio;
                montoTotal += parseFloat(precio);

                // Insertar en servicioCita
                await connection.execute(
                    'INSERT INTO servicioCita (idCita, idSer, total) VALUES (?, ?, ?)',
                    [idCita, idSer, precio]
                );
            }

            // 4ï¸âƒ£ CREAR PAGO
            await connection.execute(
                'INSERT INTO pago (idCita, monto, metodoPago, estado) VALUES (?, ?, ?, ?)',
                [idCita, montoTotal, metodoPago, 'pendiente']
            );

            // âœ… CONFIRMAR TRANSACCIÃ“N
            await connection.commit();

            return { idCita, monto: montoTotal };

        } catch (error) {
            // âŒ REVERTIR TRANSACCIÃ“N SI HAY ERROR
            await connection.rollback();
            throw error;
        } finally {
            connection.release();
        }
    }

    // âœ… COMPLETAR CITA
    static async completarCita(idCita, idBarbero) {
        try {
            // VERIFICAR QUE LA CITA PERTENECE AL BARBERO
            const [cita] = await pool.execute(
                'SELECT estado FROM cita WHERE idCita = ? AND idBarbero = ?',
                [idCita, idBarbero]
            );

            if (cita.length === 0) {
                throw new Error('Cita no encontrada');
            }

            if (cita[0].estado === 'completada') {
                throw new Error('La cita ya estÃ¡ completada');
            }

            // ACTUALIZAR ESTADO
            await pool.execute(
                'UPDATE cita SET estado = ? WHERE idCita = ?',
                ['completada', idCita]
            );

            // ACTUALIZAR PAGO
            await pool.execute(
                'UPDATE pago SET estado = ? WHERE idCita = ?',
                ['pagado', idCita]
            );

            return { success: true, message: 'Cita completada exitosamente' };
        } catch (error) {
            throw error;
        }
    }
}

export default CitaService;
```

**ğŸ“Š Flujo de Crear Cita:**

```
Cliente selecciona:
  - Barbero: Carlos
  - Fecha: 2025-11-26
  - Hora: 10:00
  - Servicios: [Corte, Barba]
       â†“
POST /api/citas
       â†“
citaRoutes.js â†’ CitaService.crearCita()
       â†“
TRANSACCIÃ“N SQL:
  1. SELECT: Â¿Barbero disponible a esa hora?
  2. INSERT INTO cita (...)
  3. SELECT precio FROM servicio WHERE idSer IN (1,2)
  4. INSERT INTO servicioCita (idCita=X, idSer=1, total=15000)
  5. INSERT INTO servicioCita (idCita=X, idSer=2, total=10000)
  6. INSERT INTO pago (idCita=X, monto=25000)
  7. COMMIT (todo OK) o ROLLBACK (si hay error)
       â†“
Retorna: { idCita: 123, monto: 25000 }
```

---

### ğŸ“„ Ejemplo 3: `adminService.js` - Panel Administrativo

```javascript
import pool from '../config/database.js';

class AdminService {
    // ğŸ“Š ESTADÃSTICAS DE CLIENTES
    static async getClientesStats(filtros = {}) {
        try {
            let query = `
                SELECT 
                    u.idUsuario as idCliente,
                    u.nombre,
                    u.correo,
                    u.telefono,
                    u.cedula,
                    COUNT(c.idCita) as totalCitas,
                    COUNT(CASE WHEN c.estado = 'completada' THEN 1 END) as citasCompletadas,
                    COUNT(CASE WHEN c.estado = 'cancelada' THEN 1 END) as citasCanceladas,
                    COUNT(CASE WHEN c.estado = 'pendiente' THEN 1 END) as citasPendientes,
                    SUM(CASE WHEN c.estado = 'completada' AND p.estado = 'pagado' 
                        THEN p.monto ELSE 0 END) as totalGastado,
                    MAX(c.fecha) as ultimaCita
                FROM usuario u
                INNER JOIN cliente cl ON u.idUsuario = cl.idCliente
                LEFT JOIN cita c ON cl.idCliente = c.idCliente
                LEFT JOIN pago p ON c.idCita = p.idCita
                WHERE 1=1
            `;

            const params = [];

            // FILTROS DINÃMICOS
            if (filtros.nombre) {
                query += ' AND u.nombre LIKE ?';
                params.push(`%${filtros.nombre}%`);
            }

            if (filtros.cedula) {
                query += ' AND u.cedula = ?';
                params.push(filtros.cedula);
            }

            query += ' GROUP BY u.idUsuario ORDER BY totalGastado DESC';

            const [clientes] = await pool.execute(query, params);
            return clientes;

        } catch (error) {
            throw error;
        }
    }

    // ğŸ’° INGRESOS TOTALES DEL NEGOCIO
    static async getIngresosTotales(fechaInicio, fechaFin) {
        try {
            const [result] = await pool.execute(
                `SELECT 
                    COUNT(DISTINCT c.idCita) as totalCitas,
                    SUM(p.monto) as ingresoTotal,
                    AVG(p.monto) as promedioIngreso,
                    COUNT(DISTINCT c.idBarbero) as barberosActivos
                FROM cita c
                INNER JOIN pago p ON c.idCita = p.idCita
                WHERE c.fecha BETWEEN ? AND ?
                AND c.estado = 'completada'
                AND p.estado = 'pagado'`,
                [fechaInicio, fechaFin]
            );

            return result[0];
        } catch (error) {
            throw error;
        }
    }
}

export default AdminService;
```

---

## 5. CAPA DE RUTAS (CONTROLADORES) <a name="capa-rutas"></a>

### ğŸš¦ Â¿QuÃ© son las Rutas?

Las **rutas** (controladores) son el punto de entrada de las peticiones HTTP. Su funciÃ³n:
- âœ… Recibir la peticiÃ³n del cliente
- âœ… Validar datos de entrada
- âœ… Llamar al servicio correspondiente
- âœ… Enviar respuesta al cliente

---

### ğŸ“„ Ejemplo: `authRoutes.js`

```javascript
import express from 'express';
import AuthService from '../services/authService.js';
import { body, validationResult } from 'express-validator';
import rateLimit from 'express-rate-limit';

const router = express.Router();

// ğŸ›¡ï¸ RATE LIMITER - Prevenir ataques de fuerza bruta
const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,  // 15 minutos
    max: 5,                     // 5 intentos mÃ¡ximo
    message: {
        success: false,
        message: 'Demasiados intentos. Intenta en 15 minutos.'
    }
});

// ğŸ” POST /api/auth/login - Iniciar sesiÃ³n
router.post('/login',
    loginLimiter,  // Aplicar rate limiting
    [
        // VALIDACIONES
        body('correo').trim().notEmpty().withMessage('Correo requerido'),
        body('contrasena').trim().notEmpty().withMessage('ContraseÃ±a requerida')
    ],
    async (req, res) => {
        try {
            console.log('ğŸ“¨ Login attempt:', { correo: req.body.correo });
            
            // VERIFICAR ERRORES DE VALIDACIÃ“N
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                console.log('âŒ Validation errors:', errors.array());
                return res.status(400).json({
                    success: false,
                    message: 'Datos invÃ¡lidos',
                    errors: errors.array()
                });
            }

            const { correo, contrasena } = req.body;

            // LLAMAR AL SERVICIO
            const user = await AuthService.login(correo, contrasena);

            console.log('âœ… Login successful:', user.correo);
            res.json({
                success: true,
                message: 'Login exitoso',
                data: user
            });
        } catch (error) {
            console.error('âŒ Login error:', error.message);
            res.status(401).json({
                success: false,
                message: error.message
            });
        }
    }
);

// ğŸ“ POST /api/auth/register - Registrar nuevo usuario
router.post('/register',
    [
        body('nombre').trim().isLength({ min: 3 }),
        body('correo').isEmail().normalizeEmail(),
        body('telefono').matches(/^\d{10}$/),
        body('contrasena').isLength({ min: 6 }),
        body('cedula').matches(/^\d{7,10}$/),
        body('rol').isIn(['admin', 'cliente', 'barbero'])
    ],
    async (req, res) => {
        try {
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                return res.status(400).json({
                    success: false,
                    errors: errors.array()
                });
            }

            const result = await AuthService.register(req.body);

            res.status(201).json({
                success: true,
                message: 'Usuario registrado exitosamente',
                data: result
            });
        } catch (error) {
            res.status(400).json({
                success: false,
                message: error.message
            });
        }
    }
);

export default router;
```

### ğŸ“Š Flujo de una PeticiÃ³n HTTP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENTE   â”‚ (React)
â”‚ (Frontend)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/auth/login
       â”‚ { correo: "...", contrasena: "..." }
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MIDDLEWARE     â”‚
â”‚  - CORS          â”‚ â† Permite peticiones del frontend
â”‚  - Body Parser   â”‚ â† Parsea JSON del body
â”‚  - Rate Limiter  â”‚ â† Previene ataques
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ authRoutes.js    â”‚
â”‚ (Controlador)    â”‚
â”‚  - Valida datos  â”‚ â† express-validator
â”‚  - Llama servicioâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ authService.js   â”‚
â”‚ (LÃ³gica Negocio) â”‚
â”‚  - Query SQL     â”‚
â”‚  - Bcrypt        â”‚
â”‚  - JWT           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  database.js     â”‚
â”‚  (Pool MySQL)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL DB       â”‚
â”‚  barberia_       â”‚
â”‚   barberez       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ Retorna datos
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RESPUESTA      â”‚
â”‚   JSON           â”‚
â”‚ { success: true, â”‚
â”‚   data: {...},   â”‚
â”‚   token: "..."   â”‚
â”‚ }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. FRONTEND - CONSUMO DE APIs <a name="frontend-apis"></a>

### ğŸ“¡ Archivo: `frontend/src/services/api.js`

```javascript
import axios from 'axios';

// CONFIGURACIÃ“N BASE DE AXIOS
const api = axios.create({
    baseURL: 'http://localhost:5000/api',
    timeout: 30000,  // 30 segundos
    headers: {
        'Content-Type': 'application/json'
    }
});

// ğŸ” INTERCEPTOR DE REQUESTS - Agregar token JWT
api.interceptors.request.use(
    (config) => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    },
    (error) => {
        return Promise.reject(error);
    }
);

// ğŸ”„ INTERCEPTOR DE RESPONSES - Manejar errores
api.interceptors.response.use(
    (response) => response,
    async (error) => {
        if (error.response?.status === 401) {
            // Token expirado - Redirigir al login
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);

// ===============================
// ğŸ” AUTENTICACIÃ“N
// ===============================

export const login = async (correo, contrasena) => {
    const response = await api.post('/auth/login', { correo, contrasena });
    return response.data;
};

export const register = async (userData) => {
    const response = await api.post('/auth/register', userData);
    return response.data;
};

// ===============================
// ğŸ“… CITAS
// ===============================

export const getCitasCliente = async () => {
    const response = await api.get('/citas/cliente');
    return response.data;
};

export const crearCita = async (citaData) => {
    const response = await api.post('/citas', citaData);
    return response.data;
};

export const cancelarCita = async (idCita) => {
    const response = await api.put(`/citas/${idCita}/cancelar`);
    return response.data;
};

// ===============================
// ğŸ‘¨â€ğŸ’¼ BARBEROS
// ===============================

export const getBarberosDisponibles = async (fecha) => {
    const response = await api.get(`/barberos/disponibles?fecha=${fecha}`);
    return response.data;
};

// ===============================
// ğŸ’ˆ SERVICIOS
// ===============================

export const getServiciosActivos = async () => {
    const response = await api.get('/servicios');
    return response.data;
};

export default api;
```

### ğŸ“„ Ejemplo de Uso en Componente React

```javascript
// frontend/src/pages/Login.jsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { login } from '../services/api';

function Login() {
    const [correo, setCorreo] = useState('');
    const [contrasena, setContrasena] = useState('');
    const [error, setError] = useState('');
    const navigate = useNavigate();

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            // LLAMAR A LA API
            const response = await login(correo, contrasena);
            
            // GUARDAR TOKEN Y USUARIO
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));
            
            // REDIRIGIR SEGÃšN ROL
            if (response.data.rol === 'admin') {
                navigate('/admin/dashboard');
            } else if (response.data.rol === 'barbero') {
                navigate('/barbero/dashboard');
            } else {
                navigate('/cliente/dashboard');
            }
        } catch (err) {
            setError(err.response?.data?.message || 'Error al iniciar sesiÃ³n');
        }
    };

    return (
        <form onSubmit={handleSubmit}>
            <input 
                type="email" 
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                placeholder="Correo"
            />
            <input 
                type="password" 
                value={contrasena}
                onChange={(e) => setContrasena(e.target.value)}
                placeholder="ContraseÃ±a"
            />
            {error && <p className="error">{error}</p>}
            <button type="submit">Iniciar SesiÃ³n</button>
        </form>
    );
}
```

---

## 7. FLUJO COMPLETO DE UNA PETICIÃ“N <a name="flujo-peticion"></a>

### ğŸ”„ Ejemplo: Cliente Agenda una Cita

```
1ï¸âƒ£ FRONTEND (React)
   â””â”€ ClienteDashboard.jsx
      â””â”€ handleAgendar() {
            const citaData = {
              fecha: "2025-11-26",
              horaIn: "10:00",
              idBarbero: 7,
              servicios: [1, 2],
              metodoPago: "efectivo"
            };
            await crearCita(citaData);
         }

2ï¸âƒ£ API CLIENT (Axios)
   â””â”€ api.js
      â””â”€ export const crearCita = async (citaData) => {
            // Agrega token JWT al header
            return api.post('/citas', citaData);
         }

3ï¸âƒ£ HTTP REQUEST
   â””â”€ POST http://localhost:5000/api/citas
      Headers: {
        Authorization: "Bearer eyJhbGc...",
        Content-Type: "application/json"
      }
      Body: { fecha, horaIn, idBarbero, servicios, metodoPago }

4ï¸âƒ£ BACKEND (Express)
   â””â”€ server.js
      â”œâ”€ MIDDLEWARE: CORS â†’ Body Parser â†’ Logging
      â””â”€ RUTAS: app.use('/api/citas', citaRoutes)

5ï¸âƒ£ CONTROLADOR (Rutas)
   â””â”€ citaRoutes.js
      â””â”€ router.post('/', auth, validaciones, async (req, res) => {
            const result = await CitaService.crearCita(req.body);
            res.json({ success: true, data: result });
         })

6ï¸âƒ£ SERVICIO (LÃ³gica)
   â””â”€ citaService.js
      â””â”€ static async crearCita(citaData) {
            const conn = await pool.getConnection();
            await conn.beginTransaction();
            
            // 1. Verificar disponibilidad
            SELECT * FROM cita WHERE ...
            
            // 2. Crear cita
            INSERT INTO cita (fecha, horaIn, ...) VALUES (?, ?, ...)
            
            // 3. Agregar servicios
            INSERT INTO servicioCita (idCita, idSer, total) VALUES ...
            
            // 4. Crear pago
            INSERT INTO pago (idCita, monto, ...) VALUES ...
            
            await conn.commit();
            return { idCita, monto };
         }

7ï¸âƒ£ BASE DE DATOS (MySQL)
   â””â”€ barberia_barberez
      â”œâ”€ cita (nueva fila insertada)
      â”œâ”€ servicioCita (2 filas insertadas)
      â””â”€ pago (1 fila insertada)

8ï¸âƒ£ RESPUESTA
   â””â”€ MySQL â†’ Service â†’ Route â†’ Express â†’ HTTP Response
      {
        "success": true,
        "data": {
          "idCita": 28,
          "monto": 25000
        }
      }

9ï¸âƒ£ FRONTEND (React)
   â””â”€ Recibe respuesta
      â””â”€ Muestra notificaciÃ³n: "Cita agendada exitosamente"
      â””â”€ Actualiza lista de citas
```

---

## 8. SEGURIDAD Y AUTENTICACIÃ“N <a name="seguridad"></a>

### ğŸ” JWT (JSON Web Tokens)

#### Â¿QuÃ© es JWT?
```
JWT = Header + Payload + Signature

Ejemplo:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9    â† Header (algoritmo)
.
eyJpZFVzdWFyaW8iOjEsImNvcnJlbyI6ImFkbWluQC4uLiJ9    â† Payload (datos)
.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c    â† Signature (firma)
```

#### Flujo de AutenticaciÃ³n

```
1ï¸âƒ£ LOGIN
   Cliente â†’ POST /api/auth/login
   Servidor:
     - Verifica usuario/contraseÃ±a
     - Genera JWT: jwt.sign({ idUsuario, rol }, SECRET, { expiresIn: '8h' })
     - Retorna: { token: "eyJ...", user: {...} }
   Cliente guarda token en localStorage

2ï¸âƒ£ PETICIONES PROTEGIDAS
   Cliente â†’ GET /api/citas/cliente
   Headers: { Authorization: "Bearer eyJ..." }
   
   Middleware auth.js:
     const token = req.headers.authorization?.split(' ')[1];
     const decoded = jwt.verify(token, SECRET);
     req.user = decoded;  // { idUsuario, rol }
     next();
   
   Route â†’ Service â†’ DB â†’ Response

3ï¸âƒ£ TOKEN EXPIRADO
   Cliente â†’ GET /api/citas
   Servidor â†’ 401 Unauthorized
   Interceptor detecta 401 â†’ Redirige a /login
```

### ğŸ›¡ï¸ Middleware de AutenticaciÃ³n

```javascript
// backend/middleware/auth.js
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET;

export const auth = (req, res, next) => {
    try {
        // 1ï¸âƒ£ EXTRAER TOKEN DEL HEADER
        const token = req.headers.authorization?.split(' ')[1];
        
        if (!token) {
            return res.status(401).json({
                success: false,
                message: 'Token no proporcionado'
            });
        }

        // 2ï¸âƒ£ VERIFICAR Y DECODIFICAR TOKEN
        const decoded = jwt.verify(token, JWT_SECRET);
        
        // 3ï¸âƒ£ AGREGAR USUARIO A LA REQUEST
        req.user = decoded;  // { idUsuario, correo, rol }
        
        next();  // âœ… Token vÃ¡lido, continuar
        
    } catch (error) {
        return res.status(401).json({
            success: false,
            message: 'Token invÃ¡lido o expirado'
        });
    }
};

// MIDDLEWARE PARA VERIFICAR ROL
export const requireRole = (...roles) => {
    return (req, res, next) => {
        if (!roles.includes(req.user.rol)) {
            return res.status(403).json({
                success: false,
                message: 'No tienes permiso para realizar esta acciÃ³n'
            });
        }
        next();
    };
};
```

### ğŸ“ Uso en Rutas

```javascript
import { auth, requireRole } from '../middleware/auth.js';

// ğŸ”“ RUTA PÃšBLICA
router.post('/login', async (req, res) => { ... });

// ğŸ” RUTA PROTEGIDA (requiere login)
router.get('/citas/cliente', auth, async (req, res) => {
    const idCliente = req.user.idUsuario;  // Del token JWT
    const citas = await CitaService.getCitasCliente(idCliente);
    res.json({ success: true, data: citas });
});

// ğŸ‘® RUTA SOLO PARA ADMIN
router.get('/admin/stats', auth, requireRole('admin'), async (req, res) => {
    const stats = await AdminService.getStats();
    res.json({ success: true, data: stats });
});

// ğŸš« RUTA PARA ADMIN Y BARBERO
router.put('/citas/:id/completar', 
    auth, 
    requireRole('admin', 'barbero'), 
    async (req, res) => { ... }
);
```

---

## 9. PROCEDIMIENTOS ALMACENADOS <a name="procedimientos"></a>

### ğŸ“¦ Â¿QuÃ© son los Procedimientos Almacenados?

Son funciones SQL guardadas en la base de datos que:
- âœ… Encapsulan lÃ³gica compleja
- âœ… Se ejecutan mÃ¡s rÃ¡pido
- âœ… Reducen trÃ¡fico de red

### ğŸ“„ Ejemplo: `sp_registrar_usuario`

```sql
DELIMITER $$

CREATE PROCEDURE sp_registrar_usuario(
    IN p_nombre VARCHAR(100),
    IN p_correo VARCHAR(100),
    IN p_telefono VARCHAR(15),
    IN p_contrasena VARCHAR(255),
    IN p_cedula VARCHAR(20),
    IN p_rol ENUM('admin','cliente','barbero'),
    IN p_comision DECIMAL(5,2)
)
BEGIN
    DECLARE v_idUsuario INT;
    
    -- 1ï¸âƒ£ INSERTAR EN TABLA USUARIO
    INSERT INTO usuario (nombre, correo, telefono, contrasena, cedula, rol)
    VALUES (p_nombre, p_correo, p_telefono, p_contrasena, p_cedula, p_rol);
    
    SET v_idUsuario = LAST_INSERT_ID();
    
    -- 2ï¸âƒ£ INSERTAR EN TABLA SEGÃšN ROL
    IF p_rol = 'admin' THEN
        INSERT INTO admin (idAdmin) VALUES (v_idUsuario);
    ELSEIF p_rol = 'cliente' THEN
        INSERT INTO cliente (idCliente) VALUES (v_idUsuario);
    ELSEIF p_rol = 'barbero' THEN
        INSERT INTO barbero (idBarbero, comision) 
        VALUES (v_idUsuario, p_comision);
    END IF;
    
    -- 3ï¸âƒ£ RETORNAR RESULTADO
    SELECT v_idUsuario AS idUsuario, p_rol AS rol;
END$$

DELIMITER ;
```

### ğŸ”§ Uso desde Node.js

```javascript
// Llamar procedimiento almacenado
const [result] = await pool.execute(
    'CALL sp_registrar_usuario(?, ?, ?, ?, ?, ?, ?)',
    [nombre, correo, telefono, hashedPassword, cedula, rol, comision]
);

console.log(result[0][0]);  // { idUsuario: 11, rol: 'cliente' }
```

---

## ğŸ“Š RESUMEN EJECUTIVO

### Arquitectura del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             CLIENTE (React)                  â”‚
â”‚  - Componentes UI                           â”‚
â”‚  - Context API (estado global)              â”‚
â”‚  - Axios (peticiones HTTP)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP/JSON
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          SERVIDOR (Node.js + Express)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MIDDLEWARES                          â”‚  â”‚
â”‚  â”‚  - CORS, Body Parser, Logging         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RUTAS (Controladores)                â”‚  â”‚
â”‚  â”‚  - authRoutes.js                      â”‚  â”‚
â”‚  â”‚  - citaRoutes.js                      â”‚  â”‚
â”‚  â”‚  - barberoRoutes.js                   â”‚  â”‚
â”‚  â”‚  - adminRoutes.js                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SERVICIOS (LÃ³gica de Negocio)        â”‚  â”‚
â”‚  â”‚  - authService.js                     â”‚  â”‚
â”‚  â”‚  - citaService.js                     â”‚  â”‚
â”‚  â”‚  - barberoService.js                  â”‚  â”‚
â”‚  â”‚  - adminService.js                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CONFIGURACIÃ“N                        â”‚  â”‚
â”‚  â”‚  - database.js (Pool MySQL)           â”‚  â”‚
â”‚  â”‚  - auth.js (Middleware JWT)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ SQL Queries
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       BASE DE DATOS (MySQL)                  â”‚
â”‚  - usuario (herencia por rol)               â”‚
â”‚  - cita (reservas)                          â”‚
â”‚  - servicio (catÃ¡logo)                      â”‚
â”‚  - pago (transacciones)                     â”‚
â”‚  - servicioCita (relaciÃ³n M:N)              â”‚
â”‚  - Procedimientos almacenados               â”‚
â”‚  - Triggers y constraints                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ventajas de Esta Arquitectura

1. **SeparaciÃ³n de Responsabilidades**
   - Frontend: Solo UI y lÃ³gica de presentaciÃ³n
   - Backend: LÃ³gica de negocio y acceso a datos
   - Base de Datos: Persistencia y constraints

2. **Escalabilidad**
   - Pool de conexiones reutiliza recursos
   - Servicios independientes y modulares
   - FÃ¡cil agregar nuevas funcionalidades

3. **Seguridad**
   - JWT para autenticaciÃ³n stateless
   - Bcrypt para contraseÃ±as hasheadas
   - Rate limiting contra ataques
   - ValidaciÃ³n en mÃºltiples capas

4. **Mantenibilidad**
   - CÃ³digo organizado por responsabilidades
   - FÃ¡cil de testear (unit tests)
   - DocumentaciÃ³n clara

---

## âœ… CONCLUSIÃ“N

Este proyecto demuestra una arquitectura profesional de 3 capas:

1. **Frontend (React)**: Interfaz de usuario intuitiva
2. **Backend (Node.js/Express)**: API RESTful robusta
3. **Base de Datos (MySQL)**: Modelo relacional normalizado

**TecnologÃ­as Clave:**
- âœ… MySQL con transacciones ACID
- âœ… Pool de conexiones para eficiencia
- âœ… JWT para autenticaciÃ³n segura
- âœ… Bcrypt para encriptaciÃ³n de contraseÃ±as
- âœ… Express-validator para validaciones
- âœ… Axios con interceptors
- âœ… React Context para estado global

**Patrones de DiseÃ±o:**
- âœ… MVC (Modelo-Vista-Controlador)
- âœ… Repository Pattern (Servicios)
- âœ… Middleware Pattern
- âœ… Observer Pattern (React Context)

---

**Desarrollado por:** Keyner Rodriguez  
**Fecha:** Noviembre 2025  
**TecnologÃ­as:** Node.js, Express, MySQL, React, JWT, Bcrypt
